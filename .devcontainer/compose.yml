# create the network before building the devcontainer
# docker network create replicable
#
# build base, tools and devcontainer images (don't pull, they don't exist on first run)
# docker compose -f .devcontainer/compose.yml build base
# docker compose -f .devcontainer/compose.yml build tools
# USRID=$(id -u) USRNAME=$(whoami) docker compose -f .devcontainer/compose.yml build --no-cache --pull=false
#
# >Dev Containers: Reopen in Container
#
# compose project name #########################################################
#
# Using devcontainer, the project opens under your user name, which is what compose
# takes as the project name. This can cause issues with dependencies on other
# containers.
#
name: replicable
services:
  # Base development image with system dependencies
  base:
    build:
      context: ..
      dockerfile: .devcontainer/docker/Dockerfile.base
    image: ghcr.io/replicable/replicable-devcontainer-base:1.0.0

  # Tools image with Docker, Node.js, and CDK
  tools:
    build:
      context: ..
      dockerfile: .devcontainer/docker/Dockerfile.tools
    image: ghcr.io/replicable/replicable-devcontainer-tools:1.0.0
    depends_on:
      - base

  # devcontainer image for development
  devcontainer:
    build:
      context: ..
      dockerfile: .devcontainer/docker/Dockerfile
      args:
        USRID: ${USRID}
        USRNAME: ${USRNAME}
    image: ghcr.io/replicable/replicable-devcontainer:1.0.0
    container_name: replicable-devcontainer
    depends_on:
      - tools
